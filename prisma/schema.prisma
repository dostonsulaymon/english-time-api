generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  username     String
  email        String
  avatar       String
  rating       Int?
  coins        Int      @default(0)
  currentCoins Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  Rating       Rating[]

  status Boolean @default(false)

  premiumAvatarId String? @db.ObjectId
  premiumAvatar   Avatar? @relation(fields: [premiumAvatarId], references: [id])

  userPlans UserPlan[]

  PaymeTransaction PaymeTransaction[]
  ClickTransaction ClickTransaction[]

  @@index([coins])
}

model Avatar {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  filename     String   @unique
  originalName String
  mimetype     String
  size         Int
  path         String
  price        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relation to users who have this as premium avatar
  premiumUsers User[]

  @@map("avatar")
}

model Rating {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @db.ObjectId
  score     Int
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model Plan {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  name      String     @unique
  price     Int
  duration  Int
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  UserPlans UserPlan[]

  PaymeTransaction PaymeTransaction[]
  ClickTransaction ClickTransaction[]
}

model UserPlan {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  user      User           @relation(fields: [userId], references: [id])
  userId    String         @db.ObjectId // Removed @unique constraint
  plan      Plan           @relation(fields: [planId], references: [id])
  planId    String         @db.ObjectId
  startDate DateTime       @default(now())
  endDate   DateTime // calculated: startDate + plan.duration
  status    UserPlanStatus @default(ACTIVE) // New field to track plan status
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([userId, planId])
  @@index([endDate])
  @@index([userId, status]) // New index for efficient active plan queries
}

model PaymeTransaction {
  id           String             @id @default(auto()) @map("_id") @db.ObjectId
  userId       String             @db.ObjectId
  planId       String             @db.ObjectId
  paymeTransId String             @unique @map("payme_trans_id")
  amount       Float
  createdAt    DateTime           @default(now()) @map("created_at")
  performAt    DateTime?          @map("perform_at")
  cancelAt     DateTime?          @map("cancel_at")
  state        Int
  reason       Int?
  status       TransactionStatus?
  updatedAt    DateTime           @updatedAt @map("updated_at")

  // Relations
  plan Plan @relation(fields: [planId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@map("payme_transactions")
}

model ClickTransaction {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  userId          String            @map("user_id") @db.ObjectId
  planId          String            @map("plan_id") @db.ObjectId
  clickTransId    String            @unique @map("click_trans_id")
  merchantTransId String            @map("merchant_trans_id")
  prepareId       String            @map("prepare_id")
  status          TransactionStatus @default(PENDING)
  amount          Float
  action          Int
  signTime        DateTime          @map("sign_time")
  createdDate     DateTime          @default(now()) @map("created_date")

  plan Plan @relation(fields: [planId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@map("click_transactions")
}

enum TransactionStatus {
  PENDING
  CREATED
  PAID
  CANCELED
}

enum UserPlanStatus {
  ACTIVE
  EXPIRED
  CANCELED
}
